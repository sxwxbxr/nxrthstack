@page "/"
@inject SaveFileService SaveService
@inject PokemonService PokemonService
@inject IJSRuntime JS

<PageTitle>PKHeX Save Editor</PageTitle>

<div class="editor-container">
    @if (SaveService.CurrentSave == null)
    {
        <div class="welcome-screen">
            <div class="welcome-header">
                <h1>PKHeX Save Editor</h1>
                <p>Edit your Pokemon save files directly in the browser</p>
            </div>
            <SaveUploader OnSaveLoaded="HandleSaveLoaded" />
            <div class="features">
                <div class="feature">
                    <span class="feature-icon">ðŸŽ®</span>
                    <span>Supports Gen 1-9</span>
                </div>
                <div class="feature">
                    <span class="feature-icon">ðŸ”’</span>
                    <span>100% Local Processing</span>
                </div>
                <div class="feature">
                    <span class="feature-icon">âš¡</span>
                    <span>Powered by PKHeX.Core</span>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="editor-layout">
            <div class="editor-sidebar">
                <SaveSummary OnRequestNewSave="HandleNewSave" OnExportSave="HandleExportSave" />

                <div class="section-divider"></div>

                <TrainerEditor OnChanged="HandleDataChanged" />

                <div class="section-divider"></div>

                <div class="section-header">
                    <h3>Party Pokemon</h3>
                </div>
                <PartyViewer OnSlotSelected="HandlePartyPokemonSelected" SelectedSlot="@(isFromParty ? selectedPartySlot : null)" />

                <div class="section-divider"></div>

                <div class="section-header">
                    <h3>PC Boxes</h3>
                </div>
                <BoxViewer @bind-CurrentBox="currentBox" OnSlotSelected="HandleBoxPokemonSelected" SelectedSlot="@(!isFromParty ? selectedBoxSlot : null)" />
            </div>

            <div class="editor-main">
                <PokemonEditor Pokemon="@selectedPokemon" OnPokemonChanged="HandlePokemonChanged" />
            </div>
        </div>
    }
</div>

@code {
    private PKM? selectedPokemon;
    private int currentBox = 0;

    // Track where the selected Pokemon came from
    private bool isFromParty = false;
    private int selectedPartySlot = -1;
    private int selectedBoxSlot = -1;

    protected override void OnInitialized()
    {
        SaveService.OnSaveModified += StateHasChanged;
    }

    private async Task HandleSaveLoaded(SaveFile save)
    {
        // Notify parent frame that save was loaded
        await NotifyParent("PKHEX_SAVE_LOADED", new
        {
            game = SaveService.GetGameName(),
            generation = SaveService.GetGeneration(),
            trainerName = SaveService.GetTrainerName()
        });
        StateHasChanged();
    }

    private void HandleNewSave()
    {
        SaveService.ClearSave();
        selectedPokemon = null;
        currentBox = 0;
        isFromParty = false;
        selectedPartySlot = -1;
        selectedBoxSlot = -1;
        StateHasChanged();
    }

    private async Task HandleExportSave(byte[] data)
    {
        var fileName = $"{SaveService.GetGameName()}_{DateTime.Now:yyyyMMdd_HHmmss}.sav";
        await DownloadFile(data, fileName);
    }

    private void HandlePartyPokemonSelected(int slot)
    {
        var pokemon = PokemonService.GetPartyPokemon(slot);
        if (pokemon != null && pokemon.Species > 0)
        {
            selectedPokemon = pokemon;
            isFromParty = true;
            selectedPartySlot = slot;
            selectedBoxSlot = -1;
        }
        else
        {
            selectedPokemon = null;
        }
        StateHasChanged();
    }

    private void HandleBoxPokemonSelected(int slot)
    {
        var pokemon = PokemonService.GetBoxPokemon(currentBox, slot);
        if (pokemon != null && pokemon.Species > 0)
        {
            selectedPokemon = pokemon;
            isFromParty = false;
            selectedPartySlot = -1;
            selectedBoxSlot = slot;
        }
        else
        {
            selectedPokemon = null;
        }
        StateHasChanged();
    }

    private void HandlePokemonSelected(PKM? pokemon)
    {
        selectedPokemon = pokemon;
        StateHasChanged();
    }

    private void HandlePokemonChanged()
    {
        // Persist the changes back to the save file
        if (selectedPokemon != null)
        {
            if (isFromParty && selectedPartySlot >= 0)
            {
                PokemonService.SetPartyPokemon(selectedPartySlot, selectedPokemon);
            }
            else if (!isFromParty && selectedBoxSlot >= 0)
            {
                PokemonService.SetBoxPokemon(currentBox, selectedBoxSlot, selectedPokemon);
            }
        }
        SaveService.NotifyModified();
        StateHasChanged();
    }

    private void HandleDataChanged()
    {
        StateHasChanged();
    }

    private async Task NotifyParent(string type, object payload)
    {
        try
        {
            await JS.InvokeVoidAsync("PKHeXInterop.notifyParent", type, payload);
        }
        catch
        {
            // Parent notification is optional
        }
    }

    private async Task DownloadFile(byte[] data, string fileName)
    {
        try
        {
            await JS.InvokeVoidAsync("PKHeXInterop.downloadFile", data, fileName);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Download failed: {ex.Message}");
        }
    }
}
