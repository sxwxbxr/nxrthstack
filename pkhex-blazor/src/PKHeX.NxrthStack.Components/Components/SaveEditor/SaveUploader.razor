@using PKHeX.NxrthStack.Core.Services
@using PKHeX.Core
@inject SaveFileService SaveService

@namespace PKHeX.NxrthStack.Components.SaveEditor

<div class="save-uploader">
    <div class="upload-area @(isDragging ? "dragging" : "")"
         @ondragenter="HandleDragEnter"
         @ondragleave="HandleDragLeave"
         @ondragover:preventDefault="true"
         @ondrop="HandleDrop"
         @ondrop:preventDefault="true">

        <InputFile OnChange="HandleFileSelected"
                   accept=".sav,.dsv,.gci,.dat,.bin,.sa1,.sa2"
                   id="save-file-input"
                   class="file-input" />

        <label for="save-file-input" class="upload-label">
            <div class="upload-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="17 8 12 3 7 8"/>
                    <line x1="12" y1="3" x2="12" y2="15"/>
                </svg>
            </div>
            <p class="upload-text">
                @if (isLoading)
                {
                    <span>Loading save file...</span>
                }
                else
                {
                    <span>Drop your save file here or <strong>click to browse</strong></span>
                }
            </p>
            <p class="upload-hint">Supports: .sav, .dsv, .gci, .dat, .bin (Gen 1-9)</p>
        </label>
    </div>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="error-message">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <line x1="12" y1="8" x2="12" y2="12"/>
                <line x1="12" y1="16" x2="12.01" y2="16"/>
            </svg>
            @errorMessage
        </div>
    }
</div>

@code {
    private bool isLoading;
    private bool isDragging;
    private string? errorMessage;

    [Parameter]
    public EventCallback<SaveFile> OnSaveLoaded { get; set; }

    private void HandleDragEnter() => isDragging = true;
    private void HandleDragLeave() => isDragging = false;

    private void HandleDrop(DragEventArgs e)
    {
        isDragging = false;
        // File handling is done via InputFile component
    }

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        isLoading = true;
        errorMessage = null;
        StateHasChanged();

        try
        {
            var file = e.File;

            // Limit to 10MB
            if (file.Size > 10 * 1024 * 1024)
            {
                errorMessage = "File is too large. Maximum size is 10MB.";
                return;
            }

            using var stream = file.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024);
            using var ms = new MemoryStream();
            await stream.CopyToAsync(ms);

            var save = SaveService.LoadSave(ms.ToArray());
            if (save != null)
            {
                await OnSaveLoaded.InvokeAsync(save);
            }
            else
            {
                errorMessage = "Unable to load save file. Please check the file format is supported.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading file: {ex.Message}";
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
}
